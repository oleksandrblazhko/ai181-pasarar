# **V5.1 Перевірка вхідних даних**

Правильно реалізовані засоби контролю перевірки введення, використовуючи позитивні дозволені списки та надійну типізацію даних, можуть усунути понад 90% усіх ін’єкційних атак. Перевірки довжини та діапазону можуть зменшити це ще більше. Вбудована безпечна перевірка вхідних даних потрібна під час архітектури додатків, спринтів проектування, кодування, а також блоків і інтеграції
тестування. Хоча багато з цих елементів неможливо знайти в тестах на проникнення, результати їх нереалізації зазвичай можна знайти у V5.3 – Вимоги до кодування виводу та запобігання ін’єкціям. Розробникам і рецензентам безпечного коду рекомендується розглядати цей розділ так, ніби L1 потрібен для всіх елементів, щоб запобігти ін’єкціям.

| #     | Опис                                                                                                                                                                                                                                                                                                                                                             | L1  | L2  | L3  | CWE |
| ----- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --- | --- | --- | --- |
| 5.1.1 | Переконайтеся, що програма має захист від атак із забрудненням параметрів HTTP, особливо якщо структура програми не розрізняє джерело параметрів запиту (GET, POST, файли cookie, заголовки або змінні середовища).                                                                                                                                              | ✓   | ✓   | ✓   | 235 |
| 5.1.2 | Переконайтеся, що інфраструктури захищають від масових атак із призначенням параметрів або що програма має контрзаходи для захисту від небезпечного призначення параметрів, наприклад, позначення полів приватними чи подібне. (C5)                                                                                                                              | ✓   | ✓   | ✓   | 915 |
| 5.1.3 | Переконайтеся, що всі введені дані (поля форми HTML, запити REST, URL-параметри, HTTP-заголовки, файли cookie, пакетні файли, RSS-канали тощо) перевірені за допомогою позитивної перевірки (списки дозволених). (C5)                                                                                                                                            | ✓   | ✓   | ✓   | 20  |
| 5.1.4 | Переконайтеся, що структуровані дані строго типізовані та перевірені на відповідність визначеній схемі, включаючи дозволені символи, довжину та шаблон (наприклад, номери кредитних карток, адреси електронної пошти, номери телефонів або перевірка того, що два пов’язані поля обґрунтовані, наприклад перевірка того, що передмістя та поштовий індекс). (C5) | ✓   | ✓   | ✓   | 20  |
| 5.1.5 | Переконайтеся, що URL-адреси перенаправляють і пересилають лише пункти призначення, які містяться в дозволеному списку, або показують попередження під час перенаправлення на потенційно ненадійний вміст.                                                                                                                                                       | ✓   | ✓   | ✓   | 601 |

# **C5: перевірка всіх введених даних**

# **Опис**

Перевірка вхідних даних — це техніка програмування, яка гарантує, що лише правильно відформатовані дані можуть входити до компонента програмної системи.

## **Синтаксис і семантична валідність**

Програма повинна перевірити, чи дані є як синтаксично, так і семантично дійсними (у такому порядку), перш ніж використовувати їх у будь-який спосіб (включно з відображенням їх назад для користувача).

**Правильність синтаксису** означає, що дані знаходяться в очікуваній формі. Наприклад, програма може дозволити користувачеві вибрати чотиризначний «ідентифікатор облікового запису» для виконання певної операції. Додаток має припустити, що користувач вводить корисне навантаження SQL-ін’єкції, і повинен перевірити, що дані, введені користувачем, містять рівно чотири цифри та складаються лише з чисел (на додаток до використання належної параметризації запиту).

**Семантична валідність** включає лише прийняття вхідних даних, які знаходяться в прийнятному діапазоні для даної функціональності програми та контексту. Наприклад, під час вибору діапазонів дат дата початку має передувати даті завершення.

## **Додавання в білий список проти заборони**

Існує два загальні підходи до перевірки синтаксису введення, широко відомі як дозволені та заборонені списки:

- Скасування списку або перевірка списку заборони\* намагаються перевірити, чи дані не містять «відомо поганого» вмісту. Наприклад, веб-програма може блокувати введення, яке містить точний текст `<SCRIPT>`, щоб запобігти XSS. Однак цього захисту можна уникнути за допомогою тегу сценарію в нижньому регістрі або тегу сценарію зі змішаним регістром.
- Перевірка дозволених списків або білих списків намагається перевірити, чи певні дані відповідають набору «відомо хороших» правил. Наприклад, правило перевірки білого списку для штату США буде 2-літерним кодом, який є лише одним із дійсних штатів США.
  **Важливо** Під час створення безпечного програмного забезпечення рекомендованим мінімальним підходом є білий список. Скасування списків схильне до помилок, і його можна обійти за допомогою різних методів ухилення, і може бути небезпечним, якщо залежати від самого себе. Незважаючи на те, що заборони в списку часто можна уникнути, це часто може допомогти виявити очевидні атаки. Таким чином, у той час як **білий список** допомагає обмежити поверхню атаки, забезпечуючи правильну синтаксичну та семантичну валідність даних, **заборонений список** допомагає виявляти та потенційно зупиняти очевидні атаки.

## **Перевірка на стороні клієнта та на стороні сервера**

Перевірка введених даних має завжди виконуватися на стороні сервера для безпеки. Хоча перевірка на стороні клієнта може бути корисною як для функціональних цілей, так і для деяких цілей безпеки, часто її можна легко обійти. Це робить перевірку на стороні сервера ще важливішою для безпеки. Наприклад, перевірка JavaScript може попередити користувача про те, що певне поле має складатися з чисел, але серверна програма повинна перевірити, що надіслані дані складаються лише з чисел у відповідному числовому діапазоні для цієї функції.

## **Регулярні вирази**

Регулярні вирази пропонують спосіб перевірити, чи дані відповідають певному шаблону. Почнемо з базового прикладу.

Наступний регулярний вираз використовується для визначення правила білого списку для перевірки імен користувачів.

```
^[a-z0-9_]{3,16}$
```

Цей регулярний вираз допускає лише малі літери, цифри та символ підкреслення. Довжина імені користувача також обмежена 3 та 16 символами.

### **Увага: можливість відмови в обслуговуванні**

Слід бути обережним під час створення регулярних виразів. Погано розроблені вирази можуть призвести до потенційних умов відмови в обслуговуванні (відомих як ReDoS). Різні інструменти можуть перевірити, чи регулярні вирази не вразливі до ReDoS.

### **Увага: складність**

Регулярні вирази — це лише один із способів виконати перевірку. Деяким розробникам може бути важко підтримувати або розуміти регулярні вирази. Інші альтернативи перевірки передбачають програмне написання методів перевірки, які можуть бути легшими для деяких розробників.

## **Обмеження перевірки вхідних даних**

**Перевірка вхідних даних не завжди робить дані «безпечними», оскільки певні форми складного введення можуть бути «дійсними», але все ще небезпечними. Наприклад, дійсна адреса електронної пошти може містити атаку SQL-ін’єкцій або дійсна URL-адреса може містити атаку міжсайтового сценарію.** Додаткові засоби захисту, окрім перевірки вхідних даних, завжди слід застосовувати до таких даних, як параметризація запиту або екранування.

## **Проблеми перевірки серіалізованих даних**

Деякі форми введення настільки складні, що перевірка може лише мінімально захистити програму. Наприклад, небезпечно десеріалізувати ненадійні дані або дані, якими може маніпулювати зловмисник. Єдиний безпечний архітектурний шаблон полягає в тому, щоб не приймати серіалізовані об’єкти з ненадійних джерел або лише десеріалізувати в обмеженій ємності лише для простих типів даних. Ви повинні уникати обробки серіалізованих форматів даних і використовувати легші для захисту формати, такі як JSON, коли це можливо.

Якщо це неможливо, розгляньте серію засобів захисту під час обробки серіалізованих даних.

- Реалізуйте перевірки цілісності або шифрування серіалізованих об’єктів, щоб запобігти створенню ворожих об’єктів або підробці даних.
- Застосування строгих обмежень типу під час десеріалізації перед створенням об’єкта; зазвичай код очікує визначеного набору класів. Були продемонстровані шляхи обходу цієї техніки.
- Ізолюйте код, який десеріалізується, щоб він запускався в середовищах з дуже низькими привілеями, наприклад у тимчасових контейнерах.
  Реєстрація винятків і помилок десеріалізації безпеки, наприклад, коли вхідний тип не є очікуваним типом або десеріалізація створює винятки.
- Обмежте або відстежуйте вхідне та вихідне підключення до мережі з контейнерів або серверів, які десеріалізуються.
- Відстежуйте десеріалізацію, сповіщаючи, якщо користувач постійно десеріалізується.

## **Неочікуваний вхід користувача (масове призначення)**

Деякі фреймворки підтримують автоматичне прив’язування параметрів запитів HTTP до об’єктів на стороні сервера, які використовуються програмою. Ця функція автоматичного прив’язування може дозволити зловмиснику оновлювати об’єкти на стороні сервера, які не призначені для модифікації. За допомогою цієї функції зловмисник може змінити свій рівень контролю доступу або обійти заплановану бізнес-логіку програми.

Ця атака має кілька назв, зокрема: масове призначення, автоматичне прив’язування та впровадження об’єктів.

Як простий приклад, якщо об’єкт користувача має поле привілеїв, яке визначає рівень привілеїв користувача в програмі, зловмисник може шукати сторінки, на яких змінено дані користувача, і додати привілей=admin до надісланих параметрів HTTP. Якщо автоматичне прив’язування ввімкнено незахищеним способом, об’єкт на стороні сервера, що представляє користувача, буде відповідно змінено.

Для цього можна використовувати два підходи:

- Уникайте безпосереднього зв’язування введених даних і замість цього використовуйте об’єкти передачі даних (DTO).
- Увімкніть автоматичне прив’язування, але встановіть правила білого списку для кожної сторінки чи функції, щоб визначити, які поля можна автоматично прив’язувати.
  Більше прикладів доступно в шпаргалці масового призначення OWASP.

## **Перевірка та очищення HTML**

Розглянемо програму, яка повинна приймати HTML від користувачів (через редактор WYSIWYG, який представляє вміст як HTML, або функції, які безпосередньо приймають HTML у вхідних даних). У цій ситуації перевірка або екранування не допоможуть.

- Регулярні вирази недостатньо виразні, щоб зрозуміти всю складність HTML5.
- Кодування або екранування HTML не допоможе, оскільки це спричинить неправильне відображення HTML.

Тому вам потрібна бібліотека, яка може аналізувати та очищати текст у форматі HTML. Будь ласка, перегляньте шпаргалку XSS Prevention Cheat Sheet щодо очищення HTML, щоб дізнатися більше про очищення HTML.

## **Функціональність перевірки в бібліотеках і фреймворках**

Усі мови та більшість фреймворків надають бібліотеки перевірки або функції, які слід використовувати для перевірки даних. Бібліотеки перевірки зазвичай охоплюють загальні типи даних, вимоги до довжини, діапазони цілих чисел, перевірки «є нулем» тощо. Багато бібліотек і фреймворків перевірки дозволяють визначити ваш власний регулярний вираз або логіку для спеціальної перевірки таким чином, щоб програміст міг використовувати ці функції у вашій програмі. Приклади функцій перевірки включають функції фільтрів PHP або Hibernate Validator для Java. Приклади дезінфікуючих засобів HTML включають метод очищення Ruby on Rails, OWASP Java HTML Sanitizer або DOMPurify.

# **CWE**

## **CWE-235: Неналежна обробка додаткових параметрів**

### **Опис**

Програмне забезпечення не обробляє або обробляє неправильно, коли кількість параметрів, полів або аргументів з однаковими іменами перевищує очікувану кількість.

### **Застосовні платформи**

**Мови**<br>
Клас: Не залежить від мови (поширеність не визначена)

### **Загальні наслідки**

| Область застосування | Вплив                              | Ймовірність |
| -------------------- | ---------------------------------- | ----------- |
| Цілісність           | Технічний вплив: Неочікуваний стан |             |

## **CWE-915: Неправильно контрольована модифікація динамічно визначених атрибутів об’єкта**

### **Опис**

Програмне забезпечення отримує вхідні дані від вищестоящого компонента, який визначає кілька атрибутів, властивостей або полів, які потрібно ініціалізувати або оновити в об’єкті, але воно не контролює належним чином, які атрибути можна змінити.

### **Розширений опис**

Якщо об’єкт містить атрибути, призначені лише для внутрішнього використання, їх несподівана модифікація може призвести до уразливості.
Ця слабкість іноді відома завдяки специфічним для мови механізмам, які роблять це можливим, таким як масове призначення, автоматичне прив’язування або впровадження об’єктів.

### **Застосовні платформи**

**Мови**<br>

- Ruby (невизначена поширеність)
- ASP.NET (невизначена поширеність)
- PHP (невизначена поширеність)
- Python (невизначена поширеність)
- Клас: не залежить від мови (поширеність не визначена)

### **Загальні наслідки**

| Область застосування | Вплив                                                                                                        | Ймовірність |
| -------------------- | ------------------------------------------------------------------------------------------------------------ | ----------- |
| Цілісність           | Технічний вплив: змінити дані програми <br> Зловмисник може змінити конфіденційні дані або програмні змінні. |             |
| Цілісність           | Технічний вплив: виконання несанкціонованого коду або команд                                                 |             |
| Інша цілісність      | Технічний вплив: залежить від контексту; Змінити логіку виконання                                            |             |

## **CWE-20: неправильна перевірка введених даних**

### **Опис**

Продукт отримує вхідні дані або дані, але не перевіряє або неправильно перевіряє, що вхідні дані мають властивості, необхідні для безпечної та правильної обробки даних.

### **Розширений опис**

Перевірка вхідних даних — це часто використовувана техніка для перевірки потенційно небезпечних вхідних даних, щоб переконатися, що вхідні дані безпечні для обробки в коді або під час обміну даними з іншими компонентами. Якщо програмне забезпечення не перевіряє вхідні дані належним чином, зловмисник може створити вхідні дані у формі, яка не очікується рештою програми. Це призведе до того, що частини системи отримають ненавмисне введення, що може призвести до зміни потоку керування, довільного керування ресурсом або довільного виконання коду.

Однак перевірка вхідних даних не є єдиною технікою обробки вхідних даних. Інші методи намагаються перетворити потенційно небезпечні вхідні дані на щось безпечне, наприклад фільтрація (CWE-790), яка намагається видалити небезпечні вхідні дані, або кодування/екранування (CWE-116), які намагаються гарантувати, що вхідні дані не будуть неправильно інтерпретовані, коли він включений у вихідні дані для іншого компонента. Існують також інші методи (більше прикладів див. у CWE-138).

Перевірку введених даних можна застосувати до:

- необроблені дані - рядки, числа, параметри, вміст файлів тощо.
- метадані - інформація про необроблені дані, наприклад заголовки або розмір
  Дані можуть бути простими або структурованими. Структуровані дані можуть складатися з багатьох вкладених шарів, що складаються з комбінацій метаданих і необроблених даних з іншими простими або структурованими даними.

Багато властивостей необроблених даних або метаданих може потребувати перевірки після введення в код, наприклад:

- визначені величини, такі як розмір, довжина, частота, ціна, швидкість, кількість операцій, час тощо.
- неявні чи похідні величини, наприклад фактичний розмір файлу замість зазначеного розміру
- індексів, зсувів або позицій у складніші структури даних
- символьні ключі або інші елементи в хеш-таблиці, асоціативні масиви тощо.
- правильно оформленість, тобто синтаксична правильність - відповідність очікуваному синтаксису
- лексична коректність лексем - дотримання правил щодо того, що трактується як лексема
- заданий або похідний тип - фактичний тип введення (або те, що введення виглядає)
- узгодженість – між окремими елементами даних, між необробленими даними та метаданими, між посиланнями тощо.
- відповідність правилам домену, напр. бізнес-логіка
- еквівалентність - забезпечення того, що еквівалентні вхідні дані обробляються однаково
- автентичність, право власності чи інші підтвердження щодо введених даних, напр. криптографічний підпис для підтвердження джерела даних

Неявні або похідні властивості даних часто повинні обчислюватися або виводитися за допомогою самого коду. Помилки в отриманні властивостей можуть вважатися фактором, що сприяє неправильній перевірці вхідних даних.

Зверніть увагу, що «перевірка вхідних даних» має дуже різні значення для різних людей або в різних схемах класифікації. Слід бути обережним, посилаючись на цей запис CWE або зіставляючи його. Наприклад, деякі недоліки можуть передбачати ненавмисне надання зловмиснику контролю над вхідними даними, коли вони взагалі не повинні мати змоги надати вхідні дані, але іноді це називають перевіркою вхідних даних.

Нарешті, важливо підкреслити, що відмінності між перевіркою вхідних даних і екрануванням вихідних даних часто розмиті, і розробники повинні бути обережними, щоб зрозуміти різницю, зокрема те, що перевірки вхідних даних не завжди достатньо, щоб запобігти вразливостям, особливо коли мають бути менш суворі типи даних. підтримується, як-от текст у довільній формі. Розглянемо сценарій впровадження SQL, у якому в запит вставляється прізвище людини. Ім'я "O'Reilly", швидше за все, пройде етап перевірки, оскільки це поширене прізвище в англійській мові. Однак це дійсне ім’я не можна безпосередньо вставити в базу даних, оскільки воно містить символ апостроф «'», який потрібно було б екранувати або іншим чином трансформувати. У цьому випадку видалення апострофа може зменшити ризик впровадження SQL, але це призведе до неправильної поведінки, оскільки буде записане неправильне ім’я.

### **Застосовні платформи**

**Мови**<br>
Клас: Не залежить від мови (поширеність не визначена)

### **Загальні наслідки**

| Область застосування                              | Вплив                                                                                                                                                                                                                                                   | Ймовірність |
| ------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| Доступність                                       | Технічний вплив: DoS: збій, вихід або перезапуск; DoS: споживання ресурсів (ЦП); DoS: споживання ресурсів (пам'ять). Зловмисник може надати несподівані значення та спричинити збій програми або надмірне споживання ресурсів, наприклад пам’яті та ЦП. |             |
| Конфіденційність                                  | Технічний вплив: читання пам'яті; Читання файлів або каталогів Зловмисник може прочитати конфіденційні дані, якщо він може контролювати посилання на ресурси.                                                                                           |             |
| Цілісність <br> Конфіденційність <br> Доступність | Технічний вплив: зміна пам'яті; Виконайте несанкціонований код або команди Зловмисник може використати зловмисний вхід, щоб змінити дані або, можливо, змінити потік керування несподіваним чином, включаючи довільне виконання команд.                 |             |

## **CWE-601: перенаправлення URL-адреси на ненадійний сайт («відкрите перенаправлення»)**

### **Опис**

Веб-додаток приймає керований користувачем вхід, який визначає посилання на зовнішній сайт, і використовує це посилання в перенаправленні. Це спрощує фішингові атаки.

### **Розширений опис**

Параметр http може містити значення URL-адреси та може змусити веб-програму перенаправити запит на вказану URL-адресу. Змінивши значення URL-адреси на шкідливий сайт, зловмисник може успішно запустити фішинг і викрасти облікові дані користувача. Оскільки назва сервера у зміненому посиланні ідентична оригінальному сайту, спроби фішингу виглядають більш надійно.

### **Застосовні платформи**

**Мови**<br>
Клас: Не залежить від мови (поширеність не визначена)

**Технології** <br>
Клас: Інтернет (невизначена поширеність)

### **Ймовірність експлойту**

Низький

### **Загальні наслідки**

| Область застосування                                    | Вплив                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | Ймовірність |
| ------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------- |
| Управління доступом                                     | Технічний вплив: захисний механізм обходу; Отримайте привілеї або присвойте собі ідентифікацію. <br> Користувач може бути перенаправлений на ненадійну сторінку, яка містить зловмисне програмне забезпечення, яке потім може скомпрометувати машину користувача. Це піддасть користувача значному ризику, а взаємодія користувача з веб-сервером також може бути скомпрометована, якщо зловмисне програмне забезпечення проводить клавіатурний журнал або інші атаки, які викрадають облікові дані, ідентифікаційну інформацію (PII) або інші важливі дані. |
| Управління доступом <br> Конфіденційність<br> Інший<br> | Технічний вплив: захисний механізм обходу; Отримати привілеї або отримати ідентифікацію; <br> Інший Користувач може стати жертвою фішингових атак через перенаправлення на ненадійну сторінку. Фішингова атака може вказувати на контрольовану зловмисником веб-сторінку, яка виглядає як надійний веб-сайт. Потім фішери можуть викрасти облікові дані користувача, а потім використовувати ці облікові дані для доступу до законного веб-сайту.                                                                                                            |
